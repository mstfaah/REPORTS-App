<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">REPORTS</title>
    <!-- ????? Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ???? ????????? */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* ????? ?????? ????? */
            transition: background-color 0.5s ease; /* ?????? ??? ??????? */
        }
        /* ??? ??????? */
        body.emergency-mode {
            background-color: #fee2e2; /* ???? ???? ???? ??????? */
        }
        body.emergency-mode .container {
            border: 2px solid #ef4444; /* ???? ????? */
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2); /* ?? ???? */
        }
        body.emergency-mode .app-header .title,
        body.emergency-mode label,
        body.emergency-mode .input-field,
        body.emergency-mode .btn {
            color: #b91c1c; /* ?? ???? ???? */
        }
        body.emergency-mode .input-field {
            border-color: #ef4444; /* ???? ????? */
        }
        body.emergency-mode .btn-primary {
            background-image: linear-gradient(to right, #ef4444 0%, #dc2626 50%, #ef4444 100%); /* ???? ???? */
        }
        body.emergency-mode .btn-secondary {
            background-color: #b91c1c; /* ???? ???? */
        }
        body.emergency-mode .btn-secondary:hover {
            background-color: #991b1b; /* ???? ???? */
        }
        body.emergency-mode .favorite-site-tag {
            background-color: #fca5a5; /* ???? ???? */
            color: #b91c1c; /* ???? ???? */
        }
        body.emergency-mode .favorite-site-tag:hover {
            background-color: #f87171; /* ???? ???? */
        }
        body.emergency-mode .message-box {
            background-color: #ef4444; /* ???? ?????? ??????? */
        }


        /* ????? ??????? ???????? */
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* ?? ???? */
            transition: all 0.5s ease; /* ?????? ??? ?????? ????? */
        }
        /* ????? ?????? ??????? */
        .input-group label {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: block;
            color: #334155; /* ?? ???? ???????? */
        }
        /* ????? ???? ??????? ??????? */
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1; /* ???? ?????? ????? */
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #475569; /* ?? ????? ????? */
            transition: all 0.3s ease; /* ?????? ??? ?????? */
        }
        /* ????? ??????? ?????? */
        .btn {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease; /* ?????? ??? ??? ??????? */
            font-size: 1.125rem; /* ?? ???? ??????? */
        }
        /* ????? ???? ??????? (???????) */
        .btn-primary {
            /* ????? ???? ???? ?????? ???????? */
            background-image: linear-gradient(to right, #22c55e 0%, #16a34a 50%, #22c55e 100%);
            background-size: 200% auto; /* ??? ????? ?????? ?????? ????????? */
            color: white;
            transition: background-position 0.5s ease; /* ?????? ??? ????? ??????? */
        }
        .btn-primary:hover {
            background-position: -100% 0; /* ????? ??????? ?????? (?????? ?? RTL) */
        }
        /* ????? ???? ??????? (?????? ??????) */
        .btn-secondary {
            background-color: #64748b; /* ????? ???? ??????? */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #475569; /* ????? ???? ??? ??????? */
        }
        /* ????? ?????? ??????? ???????? */
        .report-card {
            background-color: #f8fafc; /* ???? ????? ???? ???? ??????? ??????? */
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); /* ?? ???? */
        }
        /* ????? ????? ???? ?????? ??????? */
        .report-card img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
        }
        /* ????? ????? ??????? (???????/?????) */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #22c55e; /* ???? ??????? ?????? */
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* ????? ????? ??? ??????? ?????? */
            text-align: center;
            font-size: 1.25rem;
            display: none; /* ???? ????????? */
        }
        /* ????? ?? ??? ???????? ?????? */
        .delete-image-btn {
            background-color: #ef4444; /* ???? */
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex; /* ?????? ???????? ????? */
            align-items: center;
            justify-content: center;
            font-size: 0.875rem; /* ?? ???? */
            line-height: 1; /* ????? ?????? ???????? ????? ???? ??? */
            margin-top: 0.5rem; /* ????? ???? ???? */
            width: fit-content; /* ??? ???? ??? ??????? */
        }
        .delete-image-btn:hover {
            background-color: #dc2626; /* ???? ???? ??? ??????? */
        }
        .delete-image-btn svg {
            width: 1rem; /* ??? ?????? ??? ???????? */
            height: 1rem;
            margin-left: 0.25rem; /* ????? ??? ???? ????????? */
        }
        /* ????? ??? ??????? ?? ?????? ???????? */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; /* ????? ??????? ??? ??????? ??????? */
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0; /* ?? ???? */
            flex-wrap: wrap; /* ?????? ???????? ????????? ??? ??? ???? ??? ??????? ??????? */
        }
        .app-header .logo {
            max-height: 60px; /* ??? ?????? */
            width: auto;
            border-radius: 0.5rem; /* ???? ?????? ?????? */
            order: 2; /* ????? ?????? ????? ??? ?????? ?? ??????? RTL */
            margin-right: 0;
            margin-left: auto; /* ??? ?????? ??? ???? ?????? */
        }
        .app-header .title-container {
            flex-grow: 1; /* ?????? ??????? ???? ??????? ??????? */
            text-align: center; /* ?????? ??????? ????? ?????? ?? ??????? */
            order: 1; /* ????? ??????? ????? ????? */
            width: 100%; /* ????? ?? ???? ??????? ????? ?????? ??? ??????? ??????? */
        }
        .app-header .title {
            font-size: 2.25rem; /* ??? ?? ???? ??????? */
            font-weight: bold;
            color: #1a202c; /* ??? ???? ??????? */
            margin-bottom: 0.25rem; /* ????? ????? ??? ??????? ????? ?????? */
        }
        .app-header .copyright-text {
            font-size: 0.75rem; /* ??? ?? ???? ???? */
            color: #64748b; /* ??? ????? ???? ???? */
            display: block; /* ????? ?? ???? ???? ?? ??? ??? ?? */
            margin-top: 0.25rem; /* ????? ????? ???? ???? */
        }

        /* ??????? ??? ??????? ??????? */
        @media (max-width: 640px) {
            .app-header {
                flex-direction: column; /* ????? ????? ??? ??????? ??????? */
                align-items: center; /* ?????? ??????? ?? ??????? */
                text-align: center;
            }
            .app-header .logo {
                order: 1; /* ?????? ????? */
                margin-left: 0;
                margin-right: 0;
                margin-bottom: 1rem; /* ????? ??? ?????? */
            }
            .app-header .title-container {
                order: 2; /* ??????? ?????? */
                width: auto; /* ?????? ??????? ?????? ????? ???????? */
            }
            .app-header .title {
                font-size: 2rem; /* ????? ??? ???? ??? ??????? ??????? */
            }
        }

        /* ????? ??????? */
        .favorite-site-tag {
            background-color: #e0e7ff; /* ??? ????? ???? */
            color: #4338ca; /* ??? ?? ???? ???? */
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap; /* ??? ???? ?? ???????? */
        }
        .favorite-site-tag:hover {
            background-color: #c7d2fe; /* ??? ???? ??? ??????? */
        }
        .favorite-sites-container {
            display: flex;
            flex-wrap: wrap; /* ?????? ???????? ????????? ??? ??? ???? */
            gap: 0.5rem; /* ????? ??? ??????? */
            margin-bottom: 1rem; /* ????? ??? ??????? */
        }
        /* Language selector styling */
        .language-selector {
            margin-left: 1rem; /* Space from logo/title */
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            color: #334155;
            font-size: 0.9rem;
            cursor: pointer;
        }
        @media (max-width: 640px) {
            .language-selector {
                margin-top: 1rem; /* Space above selector on small screens */
                margin-left: 0;
            }
        }
        /* Enhanced select styling */
        .input-field.select-enhanced {
            appearance: none; /* Remove default browser arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); /* Custom SVG arrow */
            background-repeat: no-repeat;
            background-position: left 0.75rem center; /* Position arrow on the left for RTL */
            background-size: 1.5em 1.5em; /* Size of the arrow */
            padding-left: 2.5rem; /* Space for the arrow */
            padding-right: 0.75rem; /* Keep original right padding */
        }
        html[dir="ltr"] .input-field.select-enhanced {
            background-position: right 0.75rem center; /* Position arrow on the right for LTR */
            padding-right: 2.5rem; /* Space for the arrow */
            padding-left: 0.75rem; /* Keep original left padding */
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <!-- ??? ??????? ?? ?????? ???????? ????? ????? -->
        <div class="app-header">
            <div class="title-container">
                <h1 class="title" data-key="appTitle">REPORTS</h1>
                <small class="copyright-text">MR.MSTFA</small>
            </div>
            <!-- ??????: ????? ????? 225.JPG ?????? ???? ??? ???? ???? placeholder -->
            <img src="225.JPG" onerror="this.src='https://placehold.co/60x60/000000/FFFFFF?text=Logo'" alt="???? ??????" class="logo">
            <!-- ???? ????? -->
            <select id="languageSelector" class="language-selector">
                <option value="ar">???????</option>
                <option value="en">English</option>
            </select>
        </div>

        <!-- ??? ??????? ?????? (??????? ?????? ??????) -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-sm">
            <div class="mb-4">
                <label for="faultType" class="text-lg font-semibold text-gray-700 mb-2 block" data-key="labelFaultType">
                    ??? ?????:
                </label>
                <select id="faultType" class="input-field select-enhanced"> <!-- Added select-enhanced class -->
                    <option value="" data-key="selectFaultTypePlaceholder">???? ??? ?????</option>
                    <option value="plumbing" data-key="faultTypePlumbing">?????</option>
                    <option value="electricity" data-key="faultTypeElectricity">??????</option>
                    <option value="hvac" data-key="faultTypeHVAC">????? ??????</option>
                    <option value="network" data-key="faultTypeNetwork">???? ???????</option>
                    <option value="electronics" data-key="faultTypeElectronics">????? ?????????</option>
                    <option value="furniture" data-key="faultTypeFurniture">???? ??????</option>
                    <option value="cleaning" data-key="faultTypeCleaning">????? ??????</option>
                    <option value="construction" data-key="faultTypeConstruction">????? ????</option>
                    <option value="other" data-key="faultTypeOther">????</option>
                    <option value="emergency" data-key="faultTypeEmergency">????</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="reportDate" class="text-lg font-semibold text-gray-700 mb-2 block" data-key="labelDate">
                    ???????:
                </label>
                <input type="date" id="reportDate" class="input-field" required>
            </div>
            <div>
                <label for="reportTime" class="text-lg font-semibold text-gray-700 mb-2 block" data-key="labelTime">
                    ?????:
                </label>
                <input type="time" id="reportTime" class="input-field" required>
            </div>
        </div>

        <!-- ??? ?????? ?????? -->
        <div class="mb-6">
            <label for="imageUpload" class="text-lg font-semibold text-gray-700 mb-2 block" data-key="labelCaptureImage">
                ????? ???? ?????:
            </label>
            <!-- ??? ????? ????? ?????? ?????? ???????? -->
            <input type="file" id="imageUpload" accept="image/*,video/*" capture="environment" class="hidden"> <!-- Added video/* to accept -->
            <!-- ?? ?????? ??? ????? ????? -->
            <button id="captureImageBtn" class="btn btn-secondary w-full flex items-center justify-center gap-2" data-key="btnCaptureImage">
                <!-- ?????? ???????? (SVG) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M4.5 4.5a3 3 0 0 0-3 3v9a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3v-9a3 3 0 0 0-3-3H4.5ZM19.94 12.08a.75.75 0 0 0-.28-.51l-2.47-2.47a.75.75 0 0 0-.52-.22H14.25V7.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75v1.34L7.02 9.1a.75.75 0 0 0-.51.28l-2.47 2.47a.75.75 0 0 0-.22.52V16.5a.75.75 0 0 0 .75.75h15a.75.75 0 0 0 .75-.75v-4.47a.75.75 0 0 0-.26-.5Z" />
                    <path fill-rule="evenodd" d="M12 7.5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 12 7.5ZM10.5 12a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" clip-rule="evenodd" />
                </svg>
                <span data-key="btnCaptureImageText">????? ????</span>
            </button>
            <!-- ?????? ?????? ???????? ??? ????? -->
            <div id="imagePreviewContainer" class="mt-4 hidden relative">
                <img id="imagePreview" src="" alt="?????? ??????" class="w-full h-auto border border-gray-300 rounded-lg">
                <button id="deleteImageBtn" class="delete-image-btn absolute top-2 left-2" data-key="btnDeleteImage">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.594 19h4.812a2.75 2.75 0 0 0 2.742-2.53l.841-10.518.148.022a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.35 7.11a.75.75 0 0 0 1.5-.06l-.35-7.11Zm3.5 0a.75.75 0 0 0-1.5.06l-.35 7.11a.75.75 0 0 0 1.5-.06l.35-7.11Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- ??? ??? ?????? -->
        <div class="mb-6">
            <label for="siteName" class="text-lg font-semibold text-gray-700 mb-2 block" data-key="labelSiteName">
                ??? ??????:
            </label>
            <!-- ????? ???? ??????? ??????? -->
            <div id="favoriteSitesContainer" class="favorite-sites-container">
                <!-- ???? ????? ??????? ??????? ??? ?????? JavaScript -->
            </div>
            <input type="text" id="siteName" class="input-field" placeholder="???? ??? ??????" required data-key="placeholderSiteName">
        </div>

        <!-- ??? ??? ????? -->
        <div class="mb-6">
            <label for="faultDescription" class="text-lg font-semibold text-gray-700 mb-2 block" data-key="labelFaultDescription">
                ??? ?????:
            </label>
            <textarea id="faultDescription" rows="4" class="input-field placeholder-gray-400" placeholder="???? ????? ?????? ????? ???..." data-key="placeholderFaultDescription"></textarea>
        </div>

        <!-- ?? ????? ?????? -->
        <button id="submitReportBtn" class="btn btn-primary w-full mb-4" data-key="btnSubmitReport">
            ???? ??????
        </button>

        <!-- ?? ?????? ???????? ??????? -->
        <button id="reviewReportsBtn" class="btn btn-secondary w-full" data-key="btnReviewReports">
            ?????? ???????? ???????
        </button>

        <!-- ????? ??????? (???????) - ???? ?????? ???????? -->
        <div id="messageBox" class="message-box">
            <p id="messageText"></p>
        </div>

        <!-- ??? ???????? ??????? (??? ?????? ?? ????? ???????) -->
        <!--
        <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-4 text-center">???????? ???????</h2>
        <div id="reportsList" class="space-y-4">
            <p id="noReportsMessage" class="text-gray-500 text-center">?? ???? ?????? ????? ???.</p>
        </div>
        -->
    </div>

    <script type="module">
        // ??????? ????? Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ??????? Firebase ?????? ???????
        // **???: ?????? ??? ????? ???????? ?????? ???????? ?? ???? ???? Firebase**
        const firebaseConfig = {
            apiKey: "AIzaSyA991x4MoNlJ5XnPRY8bYa7UHLYCN50W8", // ?? ????? ??? ????? ????? ??? ??????
            authDomain: "reports-f8a7c.firebaseapp.com",
            projectId: "reports-f8a7c", // ?? ????? ????? ???
            storageBucket: "reports-f8a7c.appspot.com",
            messagingSenderId: "226959132197",
            appId: "1:226959132197:web:461fb45d4b74d4baa1cc", // ?? ????? ????? ?????? ????? ???
        };

        // ????? Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Getting DOM elements
        const htmlElement = document.documentElement;
        const languageSelector = document.getElementById('languageSelector');
        const faultTypeSelect = document.getElementById('faultType');
        const siteNameInput = document.getElementById('siteName');
        const favoriteSitesContainer = document.getElementById('favoriteSitesContainer');
        const reportDateInput = document.getElementById('reportDate');
        const reportTimeInput = document.getElementById('reportTime');
        const imageUpload = document.getElementById('imageUpload');
        const captureImageBtn = document.getElementById('captureImageBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const deleteImageBtn = document.getElementById('deleteImageBtn');
        const faultDescription = document.getElementById('faultDescription');
        const submitReportBtn = document.getElementById('submitReportBtn');
        const reviewReportsBtn = document.getElementById('reviewReportsBtn');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        let capturedFile = null; // ?????? ??? ??????/??????? ?????
        let capturedImageData = null; // ?????? ?????? ??????/??????? ????? Base64 ????? ?????? ???

        const MAX_FAVORITE_SITES = 7;
        let isEmergencyMode = false;

        // Translation object
        const translations = {
            'ar': {
                appTitle: 'REPORTS',
                labelDate: '???????:',
                labelTime: '?????:',
                labelCaptureImage: '????? ????/????? ?????:',
                btnCaptureImageText: '????? ????/?????',
                btnDeleteImage: '', // Text is empty, only icon
                labelSiteName: '??? ??????:',
                placeholderSiteName: '???? ??? ??????',
                labelFaultDescription: '??? ?????:',
                placeholderFaultDescription: '???? ????? ?????? ????? ???...',
                btnSubmitReport: '???? ??????',
                btnReviewReports: '?????? ???????? ???????',
                msgEnterSiteName: '?????? ????? ??? ??????.',
                msgEnterDateTime: '?????? ????? ??????? ??????.',
                msgCaptureOrDescribe: '?????? ?????? ????/????? ?? ????? ??? ?????.',
                msgConfirmSend: '?? ??? ????? ?? ????? ??? ???????',
                msgYes: '???',
                msgNo: '??',
                msgReportSent: '?? ????? ?????? ?????!',
                msgSendCancelled: '?? ????? ???????.',
                msgImageCleared: '?? ??? ?????.', // Updated message
                msgReviewInfo: '??? ???? ?????? ??? ???? ???????? ?? ??????? ??????.',
                msgSelectFaultType: '?????? ?????? ??? ?????.', // New message
                reportSite: '??????:',
                reportDate: '???????:',
                reportTime: '?????:',
                reportDescription: '?????:',
                reportNoDescription: '?? ???? ???',
                reportNoImage: '?? ???? ????/????? ?????.', // Updated message
                reportDelete: '???',
                reportDeleted: '?? ??? ?????? ?????.',
                labelFaultType: '??? ?????:',
                selectFaultTypePlaceholder: '???? ??? ?????',
                faultTypePlumbing: '?????',
                faultTypeElectricity: '??????',
                faultTypeHVAC: '????? ??????',
                faultTypeNetwork: '???? ???????',
                faultTypeElectronics: '????? ?????????',
                faultTypeFurniture: '???? ??????',
                faultTypeCleaning: '????? ??????',
                faultTypeConstruction: '????? ????',
                faultTypeOther: '????',
                faultTypeEmergency: '????',
                emergencySiteName: '???? ????',
                emergencyDescription: '??? ????? ?????? ???????? ???????',
            },
            'en': {
                appTitle: 'REPORTS',
                labelDate: 'Date:',
                labelTime: 'Time:',
                labelCaptureImage: 'Capture Fault Image/Video:',
                btnCaptureImageText: 'Capture Image/Video',
                btnDeleteImage: '',
                labelSiteName: 'Site Name:',
                placeholderSiteName: 'Enter site name',
                labelFaultDescription: 'Fault Description:',
                placeholderFaultDescription: 'Write a brief description of the fault here...',
                btnSubmitReport: 'Submit Report',
                btnReviewReports: 'Review Previous Reports',
                msgEnterSiteName: 'Please enter a site name.',
                msgEnterDateTime: 'Please enter date and time.',
                msgCaptureOrDescribe: 'Please capture an image/video or write a description of the fault.',
                msgConfirmSend: 'Are you sure you want to send this report?',
                msgYes: 'Yes',
                msgNo: 'No',
                msgReportSent: 'Report sent successfully!',
                msgSendCancelled: 'Submission cancelled.',
                msgImageCleared: 'File cleared.',
                msgReviewInfo: 'This button will navigate to the reports page in the full application.',
                msgSelectFaultType: 'Please select a fault type.',
                reportSite: 'Site:',
                reportDate: 'Date:',
                reportTime: 'Time:',
                reportDescription: 'Description:',
                reportNoDescription: 'No description',
                reportNoImage: 'No image attached.',
                reportDelete: 'Delete',
                reportDeleted: 'Report deleted successfully.',
                labelFaultType: 'Fault Type:',
                selectFaultTypePlaceholder: 'Select Fault Type',
                faultTypePlumbing: 'Plumbing',
                faultTypeElectricity: 'Electricity',
                faultTypeHVAC: 'HVAC/Cooling',
                faultTypeNetwork: 'Network/Internet',
                faultTypeElectronics: 'Electronic Devices',
                faultTypeFurniture: 'Furniture/Equipment',
                faultTypeCleaning: 'Cleaning/Maintenance',
                faultTypeConstruction: 'Construction Work',
                faultTypeOther: 'Other',
                faultTypeEmergency: 'Emergency',
                emergencySiteName: 'Emergency Site',
                emergencyDescription: 'Emergency fault, immediate inspection required',
            }
        };

        // Function to apply translations
        function setLanguage(lang) {
            const currentTranslations = translations[lang];
            if (!currentTranslations) return;

            htmlElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            document.querySelector('title').textContent = currentTranslations.appTitle;

            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (currentTranslations[key]) {
                    if (element.tagName === 'INPUT' && element.placeholder) {
                        element.placeholder = currentTranslations[key];
                    } else if (element.tagName === 'TEXTAREA' && element.placeholder) {
                        element.placeholder = currentTranslations[key];
                    } else {
                        element.textContent = currentTranslations[key];
                    }
                }
            });

            document.querySelector('#captureImageBtn span').textContent = currentTranslations.btnCaptureImageText;

            faultTypeSelect.querySelector('option[value=""]').textContent = currentTranslations.selectFaultTypePlaceholder;
            faultTypeSelect.querySelector('option[value="plumbing"]').textContent = currentTranslations.faultTypePlumbing;
            faultTypeSelect.querySelector('option[value="electricity"]').textContent = currentTranslations.faultTypeElectricity;
            faultTypeSelect.querySelector('option[value="hvac"]').textContent = currentTranslations.faultTypeHVAC;
            faultTypeSelect.querySelector('option[value="network"]').textContent = currentTranslations.faultTypeNetwork;
            faultTypeSelect.querySelector('option[value="electronics"]').textContent = currentTranslations.faultTypeElectronics;
            faultTypeSelect.querySelector('option[value="furniture"]').textContent = currentTranslations.faultTypeFurniture;
            faultTypeSelect.querySelector('option[value="cleaning"]').textContent = currentTranslations.faultTypeCleaning;
            faultTypeSelect.querySelector('option[value="construction"]').textContent = currentTranslations.faultTypeConstruction;
            faultTypeSelect.querySelector('option[value="other"]').textContent = currentTranslations.faultTypeOther;
            faultTypeSelect.querySelector('option[value="emergency"]').textContent = currentTranslations.faultTypeEmergency;

            languageSelector.value = lang;
            loadFavoriteSites();
        }

        const savedLanguage = localStorage.getItem('appLanguage') || 'ar';
        setLanguage(savedLanguage);

        languageSelector.addEventListener('change', (event) => {
            const newLang = event.target.value;
            localStorage.setItem('appLanguage', newLang);
            setLanguage(newLang);
        });

        function showMessage(messageKey, type = 'success') {
            const currentLang = localStorage.getItem('appLanguage') || 'ar';
            const message = translations[currentLang][messageKey] || messageKey;
            messageText.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'success') {
                messageBox.style.backgroundColor = '#22c55e';
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#ef4444';
            } else if (type === 'info') {
                messageBox.style.backgroundColor = '#3b82f6';
            }
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        function setDefaultDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');

            reportDateInput.value = `${year}-${month}-${day}`;
            reportTimeInput.value = `${hours}:${minutes}`;
        }

        function loadFavoriteSites() {
            const favoriteSites = JSON.parse(localStorage.getItem('favoriteSites')) || [];
            favoriteSitesContainer.innerHTML = '';

            favoriteSites.forEach(site => {
                const siteTag = document.createElement('span');
                siteTag.className = 'favorite-site-tag';
                siteTag.textContent = site;
                siteTag.addEventListener('click', () => {
                    siteNameInput.value = site;
                });
                favoriteSitesContainer.appendChild(siteTag);
            });
        }

        function addSiteToFavorites(siteName) {
            let favoriteSites = JSON.parse(localStorage.getItem('favoriteSites')) || [];
            
            favoriteSites = favoriteSites.filter(site => site !== siteName);
            
            favoriteSites.unshift(siteName);
            
            if (favoriteSites.length > MAX_FAVORITE_SITES) {
                favoriteSites = favoriteSites.slice(0, MAX_FAVORITE_SITES);
            }
            
            localStorage.setItem('favoriteSites', JSON.stringify(favoriteSites));
            loadFavoriteSites();
        }

        function toggleEmergencyMode(enable) {
            isEmergencyMode = enable;
            htmlElement.classList.toggle('emergency-mode', enable);

            siteNameInput.readOnly = false; // Site name is always editable
            reportDateInput.readOnly = enable;
            reportTimeInput.readOnly = enable;
            faultDescription.readOnly = enable;

            if (enable) {
                setDefaultDateTime();
                siteNameInput.value = translations[localStorage.getItem('appLanguage') || 'ar'].emergencySiteName;
                faultDescription.value = translations[localStorage.getItem('appLanguage') || 'ar'].emergencyDescription;
                favoriteSitesContainer.style.display = 'none';
            } else {
                reportDateInput.value = '';
                reportTimeInput.value = '';
                siteNameInput.value = '';
                faultDescription.value = '';
                setDefaultDateTime();
                favoriteSitesContainer.style.display = 'flex';
            }
            siteNameInput.required = true; // Site name is always required
            reportDateInput.required = !enable; // Required only in normal mode
            reportTimeInput.required = !enable; // Required only in normal mode
            faultDescription.required = false; 
        }

        faultTypeSelect.addEventListener('change', (event) => {
            if (event.target.value === 'emergency') {
                toggleEmergencyMode(true);
            } else {
                toggleEmergencyMode(false);
            }
        });

        setDefaultDateTime();

        captureImageBtn.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    capturedImageData = e.target.result; // For local preview
                };
                reader.readAsDataURL(file);
                capturedFile = file; // Store the raw file for upload to Cloud Storage
            } else {
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
                capturedImageData = null;
                capturedFile = null;
            }
        });

        deleteImageBtn.addEventListener('click', () => {
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            capturedImageData = null;
            capturedFile = null; // Clear the raw file
            imageUpload.value = '';
            imageUpload.setAttribute('accept', 'image/*,video/*');
            showMessage('msgImageCleared', 'success');
        });

        submitReportBtn.addEventListener('click', async () => { // Made async to handle promises
            const siteName = siteNameInput.value.trim();
            const reportDate = reportDateInput.value;
            const reportTime = reportTimeInput.value;
            const faultType = faultTypeSelect.value;
            const description = faultDescription.value.trim();

            if (!faultType) {
                showMessage('msgSelectFaultType', 'error'); // Updated message key
                return;
            }

            // Validation logic based on emergency mode
            if (isEmergencyMode) {
                // In emergency mode: siteName is editable, date/time/description are auto-filled.
                // Only need to ensure siteName is not empty and either file or description is present.
                if (!siteName) {
                    showMessage('msgEnterSiteName', 'error');
                    return;
                }
                if (!capturedFile && !description) {
                    showMessage('msgCaptureOrDescribe', 'error');
                    return;
                }
            } else {
                // In normal mode: all fields must be filled by user.
                if (!siteName) {
                    showMessage('msgEnterSiteName', 'error');
                    return;
                }
                if (!reportDate || !reportTime) {
                    showMessage('msgEnterDateTime', 'error');
                    return;
                }
                if (!capturedFile && !description) {
                    showMessage('msgCaptureOrDescribe', 'error');
                    return;
                }
            }

            const confirmBox = document.createElement('div');
            confirmBox.className = 'message-box';
            confirmBox.style.display = 'block';
            confirmBox.style.backgroundColor = '#3b82f6';
            
            const currentLang = localStorage.getItem('appLanguage') || 'ar';
            confirmBox.innerHTML = `
                <p class="mb-4">${translations[currentLang].msgConfirmSend}</p>
                <button id="confirmYes" class="btn btn-primary mr-2">${translations[currentLang].msgYes}</button>
                <button id="confirmNo" class="btn btn-secondary">${translations[currentLang].msgNo}</button>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmYes').addEventListener('click', async () => { // Made async
                confirmBox.remove(); // Remove confirmation box immediately

                showMessage('???? ????? ??????...', 'info'); // Loading message

                let fileUrl = null;
                if (capturedFile) {
                    try {
                        // Create a storage reference
                        const storageRef = ref(storage, `fault_media/${Date.now()}_${capturedFile.name}`);
                        // Upload the file
                        const uploadTask = await uploadBytes(storageRef, capturedFile);
                        // Get the download URL
                        fileUrl = await getDownloadURL(uploadTask.ref);
                        showMessage('?? ??? ????? ?????.', 'success');
                    } catch (error) {
                        console.error("Error uploading file:", error);
                        showMessage('??? ??? ?????: ' + error.message, 'error');
                        return; // Stop if file upload fails
                    }
                }

                try {
                    // Add site to favorites only if not in emergency mode
                    if (!isEmergencyMode) {
                        addSiteToFavorites(siteName);
                    }

                    // Save report data to Firestore
                    await addDoc(collection(db, "reports"), {
                        siteName: siteName,
                        faultType: faultType,
                        reportDate: reportDate,
                        reportTime: reportTime,
                        fileUrl: fileUrl, // Save the URL of the uploaded file
                        description: description,
                        timestamp: serverTimestamp(), // Add server timestamp
                        status: 'pending' // Default status
                    });

                    showMessage('msgReportSent', 'success');

                    // Clear form after successful submission
                    siteNameInput.value = '';
                    faultTypeSelect.value = '';
                    faultDescription.value = '';
                    imagePreview.src = '';
                    imagePreviewContainer.classList.add('hidden');
                    capturedImageData = null;
                    capturedFile = null;
                    imageUpload.value = '';
                    imageUpload.setAttribute('accept', 'image/*,video/*');
                    setDefaultDateTime();
                    toggleEmergencyMode(false);

                } catch (error) {
                    console.error("Error adding document to Firestore:", error);
                    showMessage('??? ????? ??????: ' + error.message, 'error');
                }
            });

            document.getElementById('confirmNo').addEventListener('click', () => {
                confirmBox.remove();
                showMessage('msgSendCancelled', 'error');
            });
        });

        reviewReportsBtn.addEventListener('click', () => {
            showMessage('msgReviewInfo', 'info');
        });
    </script>
</body>
</html>
